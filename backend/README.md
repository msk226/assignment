# ğŸ”‹ Point Roulette - Backend

ë§¤ì¼ ë£°ë ›ì„ ëŒë ¤ í¬ì¸íŠ¸ë¥¼ íšë“í•˜ê³ , íšë“í•œ í¬ì¸íŠ¸ë¡œ ìƒí’ˆì„ êµ¬ë§¤í•˜ëŠ” í¬ì¸íŠ¸ ë£°ë › ì„œë¹„ìŠ¤ì˜ ë°±ì—”ë“œ ì…ë‹ˆë‹¤.

## ğŸ“‘ ëª©ì°¨

- [ğŸ›  ê¸°ìˆ  ìŠ¤íƒ (Tech Stack)](#-ê¸°ìˆ -ìŠ¤íƒ-tech-stack)
- [âœ¨ ì£¼ìš” ê¸°ëŠ¥ (Key Features)](#-ì£¼ìš”-ê¸°ëŠ¥-key-features)
- [ğŸš€ ì‹œì‘í•˜ê¸° (Getting Started)](#-ì‹œì‘í•˜ê¸°-getting-started)
- [í•µì‹¬ ì„¤ê³„ (Core Design)](#í•µì‹¬-ì„¤ê³„-core-design)
- [ğŸ“‚ í”„ë¡œì íŠ¸ êµ¬ì¡° (Project Structure)](#-í”„ë¡œì íŠ¸-êµ¬ì¡°-project-structure)

---

## ğŸ›  ê¸°ìˆ  ìŠ¤íƒ (Tech Stack)

- **Language**: Kotlin 1.9.25
- **Framework**: Spring Boot 3.3.5
- **JDK**: Java 21
- **ORM**: Spring Data JPA
- **Database**: H2 (ê°œë°œ) / PostgreSQL (ìš´ì˜)
- **API ë¬¸ì„œ**: SpringDoc OpenAPI 3 (Swagger UI)
- **ë¹Œë“œ**: Gradle (Kotlin DSL)
- **ì½”ë“œ í’ˆì§ˆ**: detekt, ktlint

## âœ¨ ì£¼ìš” ê¸°ëŠ¥ (Key Features)

### ì¸ì¦

| Method | Endpoint | ì„¤ëª… |
|--------|----------|------|
| POST | `/api/auth/login` | ë¡œê·¸ì¸ (ë‹‰ë„¤ì„ ì…ë ¥, ë¯¸ê°€ì… ì‹œ ìë™ ìƒì„±) |
| GET | `/api/auth/me` | ë‚´ ì •ë³´ ì¡°íšŒ |

> ì¸ì¦ì€ `X-User-Id` í—¤ë”ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ ì‹œ ë°˜í™˜ë˜ëŠ” `userId`ë¥¼ ì´í›„ ìš”ì²­ì˜ í—¤ë”ì— í¬í•¨í•©ë‹ˆë‹¤.

### ë£°ë ›

| Method | Endpoint | ì„¤ëª… |
|--------|----------|------|
| POST | `/api/roulette/spin` | ë£°ë › ì°¸ì—¬ (1ì¼ 1íšŒ, 100~1,000p ëœë¤) |
| GET | `/api/roulette/status` | ì˜¤ëŠ˜ ì°¸ì—¬ ì—¬ë¶€ ë° ì”ì—¬ ì˜ˆì‚° ì¡°íšŒ |
| GET | `/api/roulette/history` | ë‚´ ë£°ë › ì°¸ì—¬ ë‚´ì—­ ì¡°íšŒ |

### í¬ì¸íŠ¸

| Method | Endpoint | ì„¤ëª… |
|--------|----------|------|
| GET | `/api/points` | ë‚´ í¬ì¸íŠ¸ ëª©ë¡ (ìœ íš¨ê¸°ê°„ í¬í•¨, status í•„í„° ê°€ëŠ¥) |
| GET | `/api/points/balance` | ì”ì•¡ ì¡°íšŒ (ì´ ì”ì•¡ + 7ì¼ ë‚´ ë§Œë£Œ ì˜ˆì •) |
| GET | `/api/points/expiring` | 7ì¼ ë‚´ ë§Œë£Œ ì˜ˆì • í¬ì¸íŠ¸ ìƒì„¸ ì¡°íšŒ |

### ìƒí’ˆ

| Method | Endpoint | ì„¤ëª… |
|--------|----------|------|
| GET | `/api/products` | í™œì„± ìƒí’ˆ ëª©ë¡ ì¡°íšŒ |
| GET | `/api/products/{id}` | ìƒí’ˆ ìƒì„¸ ì¡°íšŒ |

### ì£¼ë¬¸

| Method | Endpoint | ì„¤ëª… |
|--------|----------|------|
| POST | `/api/orders` | ìƒí’ˆ ì£¼ë¬¸ (í¬ì¸íŠ¸ ì°¨ê°) |
| GET | `/api/orders` | ë‚´ ì£¼ë¬¸ ë‚´ì—­ ì¡°íšŒ |

### ì–´ë“œë¯¼

| Method | Endpoint | ì„¤ëª… |
|--------|----------|------|
| GET | `/api/admin/dashboard` | ëŒ€ì‹œë³´ë“œ (ì˜ˆì‚° í˜„í™©, ì°¸ì—¬ì ìˆ˜, ì§€ê¸‰ í¬ì¸íŠ¸) |
| GET | `/api/admin/budget` | ì¼ì¼ ì˜ˆì‚° ì¡°íšŒ |
| PUT | `/api/admin/budget` | ì¼ì¼ ì˜ˆì‚° ì„¤ì • |
| GET | `/api/admin/roulette` | ì˜¤ëŠ˜ ë£°ë › ì°¸ì—¬ ëª©ë¡ |
| POST | `/api/admin/roulette/{id}/cancel` | ë£°ë › ì°¸ì—¬ ì·¨ì†Œ (í¬ì¸íŠ¸ íšŒìˆ˜) |
| GET | `/api/admin/products` | ì „ì²´ ìƒí’ˆ ëª©ë¡ (ë¹„í™œì„± í¬í•¨) |
| POST | `/api/admin/products` | ìƒí’ˆ ë“±ë¡ |
| PUT | `/api/admin/products/{id}` | ìƒí’ˆ ìˆ˜ì • |
| DELETE | `/api/admin/products/{id}` | ìƒí’ˆ ë¹„í™œì„±í™” |
| GET | `/api/admin/orders` | ì „ì²´ ì£¼ë¬¸ ëª©ë¡ |
| DELETE | `/api/admin/orders/{id}` | ì£¼ë¬¸ ì·¨ì†Œ (í¬ì¸íŠ¸ í™˜ë¶ˆ) |

## ğŸš€ ì‹œì‘í•˜ê¸° (Getting Started)

### 1. ë¡œì»¬ ê°œë°œ í™˜ê²½ (Local Development)

```bash
# ë¹Œë“œ ë° ì‹¤í–‰
./gradlew bootRun

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
./gradlew test

# ë¦°íŠ¸ ì²´í¬
./gradlew ktlintCheck detekt
```

ì‹¤í–‰ í›„ ì ‘ì†:
- API ì„œë²„: `http://localhost:8080`
- Swagger UI: `http://localhost:8080/swagger-ui.html`
- H2 ì½˜ì†”: `http://localhost:8080/h2-console` (JDBC URL: `jdbc:h2:mem:testdb`)

### 2. Docker ì‹¤í–‰ (Docker)

```bash
docker build -t voltup-backend .
docker run -p 10000:10000 \
  -e DATABASE_URL=jdbc:postgresql://host:5432/dbname?user=xxx&password=xxx \
  voltup-backend
```

## í•µì‹¬ ì„¤ê³„ (Core Design)

ì´ ì„œë¹„ìŠ¤ì˜ í•µì‹¬ì€ **"í•˜ë£¨ í•œì •ëœ ì˜ˆì‚°"** ê³¼ **"1ì¼ 1íšŒ ì°¸ì—¬"** ë¼ëŠ” ì œì•½ ì¡°ê±´ì„ ìˆ˜ë§ì€ ìœ ì €ê°€ ë™ì‹œì— ëª°ë¦¬ëŠ” ìƒí™©ì—ì„œë„ ì •í™•í•˜ê²Œ ì§€í‚¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

### ğŸ”’ ì¤‘ë³µ ì°¸ì—¬ ë°©ì§€

> **ìš”êµ¬ì‚¬í•­**: ê°™ì€ ìœ ì €ê°€ ë™ì‹œì— ë‘ ë²ˆ ìš”ì²­í•  ë•Œ, í•œ ë²ˆë§Œ ì„±ê³µí•´ì•¼ í•©ë‹ˆë‹¤.

**êµ¬í˜„ ë°©ë²•**:
1. **DB Unique Constraint**: `roulette_participations` í…Œì´ë¸”ì— `(user_id, date)` ìœ ë‹ˆí¬ ì œì•½ ì¡°ê±´ ì ìš©
   - ë™ì‹œì— INSERT ì‹œë„ ì‹œ DB ë ˆë²¨ì—ì„œ í•˜ë‚˜ë§Œ ì„±ê³µ
2. **ë¹„ê´€ì  ë½ + ìˆœì°¨ ì²´í¬**: ì˜ˆì‚° ë½ íšë“ í›„ ì°¸ì—¬ ì—¬ë¶€ë¥¼ ì²´í¬í•˜ì—¬ ì¤‘ë³µ ìš”ì²­ ì°¨ë‹¨
3. **íŠ¸ëœì­ì…˜ ê²©ë¦¬**: `@Transactional`ë¡œ ì›ìì„± ë³´ì¥

```kotlin
// RouletteParticipation ì—”í‹°í‹° - ìœ ë‹ˆí¬ ì œì•½
@Table(uniqueConstraints = [UniqueConstraint(columnNames = ["user_id", "date"])])
```

### ğŸ’° ì˜ˆì‚° ì†Œì§„ ì²˜ë¦¬

> **ìš”êµ¬ì‚¬í•­**: ì˜ˆì‚°ì´ 1,000p ë‚¨ì•˜ëŠ”ë° 5ëª…ì´ ë™ì‹œì— 500pì”© ë‹¹ì²¨ë˜ë ¤ í•œë‹¤ë©´, ì •í™•íˆ ì˜ˆì‚° ë²”ìœ„ ë‚´ì—ì„œë§Œ ì§€ê¸‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

**êµ¬í˜„ ë°©ë²•**:
1. **ë¹„ê´€ì  ë½(Pessimistic Lock)**: ì˜ˆì‚° ì¡°íšŒ ì‹œ `PESSIMISTIC_WRITE` ë½ìœ¼ë¡œ ë™ì‹œ ì ‘ê·¼ ì œì–´
   - ë½ íƒ€ì„ì•„ì›ƒ: 3ì´ˆ (ë°ë“œë½ ë°©ì§€)
2. **ì˜ˆì‚° ê²€ì¦ í›„ ì°¨ê°**: ë½ íšë“ â†’ ì”ì—¬ ì˜ˆì‚° í™•ì¸ â†’ ë‹¹ì²¨ê¸ˆ ë²”ìœ„ ê³„ì‚° â†’ ì°¨ê° ìˆœì„œë¡œ ì²˜ë¦¬
3. **ìµœì†Œ ì˜ˆì‚° ì²´í¬**: ì”ì—¬ ì˜ˆì‚°ì´ 100p ë¯¸ë§Œì´ë©´ ì°¸ì—¬ ë¶ˆê°€ (ê½ ì²˜ë¦¬)

```kotlin
// DailyBudgetRepository - ë¹„ê´€ì  ë½ ì ìš©
@Lock(LockModeType.PESSIMISTIC_WRITE)
@QueryHints(QueryHint(name = "jakarta.persistence.lock.timeout", value = "3000"))
fun findByDateWithLock(date: LocalDate): DailyBudget?
```

### ë™ì‹œì„± ì œì–´ ì „ëµ

ë‹¤ìˆ˜ì˜ ìœ ì €ê°€ ë™ì‹œì— ë£°ë ›ì— ì°¸ì—¬í•˜ê±°ë‚˜ ìƒí’ˆì„ êµ¬ë§¤í•  ë•Œ ë°ì´í„° ì •í•©ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.

| ì ìš© ëŒ€ìƒ | ì œì–´ ë°©ì‹ | ì„¤ëª… |
|-----------|-----------|------|
| ì¼ì¼ ì˜ˆì‚° | ë¹„ê´€ì  ë½ | `PESSIMISTIC_WRITE` + 3ì´ˆ íƒ€ì„ì•„ì›ƒ |
| ì¤‘ë³µ ì°¸ì—¬ | DB ìœ ë‹ˆí¬ ì œì•½ | `(user_id, date)` ë³µí•© ìœ ë‹ˆí¬ |
| ìƒí’ˆ ì¬ê³  | ë¹„ê´€ì  ë½ | êµ¬ë§¤ ì‹œ ì¬ê³  ì°¨ê° ë™ì‹œì„± ë³´ì¥ |
| í¬ì¸íŠ¸ ì°¨ê° | FIFO + íŠ¸ëœì­ì…˜ | ë§Œë£Œì¼ ìˆœ ì •ë ¬ í›„ ìˆœì°¨ ì°¨ê° |

- **ë½ íšë“ ìˆœì„œ í†µì¼**: ì˜ˆì‚° ë½ â†’ ì°¸ì—¬ ì—¬ë¶€ ì²´í¬ â†’ í¬ì¸íŠ¸ ì§€ê¸‰ ìˆœì„œë¡œ ë°ë“œë½ ë°©ì§€

### í¬ì¸íŠ¸ ì‹œìŠ¤í…œ

- **ìœ íš¨ê¸°ê°„**: íšë“ì¼ë¡œë¶€í„° 30ì¼
- **FIFO ì°¨ê°**: ìƒí’ˆ êµ¬ë§¤ ì‹œ ë§Œë£Œì¼ì´ ê°€ê¹Œìš´ í¬ì¸íŠ¸ë¶€í„° ìš°ì„  ì°¨ê°
- **ìƒíƒœ ê´€ë¦¬**: EARNED / EXPIRED / CANCELED (`effectiveStatus`ë¡œ ë§Œë£Œ ìë™ íŒë³„)
- **ì°¸ì—¬-í¬ì¸íŠ¸ ì—°ê´€**: `participationId`ë¡œ ë£°ë › ì°¸ì—¬ì™€ í¬ì¸íŠ¸ë¥¼ ì§ì ‘ ë§¤í•‘í•˜ì—¬ ì •í™•í•œ ì·¨ì†Œ ì²˜ë¦¬

### ì¼ì¼ ì˜ˆì‚°

- ê¸°ë³¸ 100,000p, ì–´ë“œë¯¼ì´ ë³€ê²½ ê°€ëŠ¥
- Lazy ìƒì„±: í•´ë‹¹ ë‚ ì§œ ì²« ìš”ì²­ ì‹œ ìë™ ìƒì„±
- ì˜ˆì‚° ì†Œì§„ ì‹œ ì°¸ì—¬ ë¶ˆê°€ (100p ë¯¸ë§Œ ì”ì—¬ ì‹œì—ë„ ë¶ˆê°€)
- ì°¸ì—¬ ì·¨ì†Œ ì‹œ ë‹¹ì¼ì´ë©´ ì˜ˆì‚° ë³µêµ¬

### ì£¼ë¬¸ ì·¨ì†Œ

- ì–´ë“œë¯¼ì´ ì£¼ë¬¸ ì·¨ì†Œ ì‹œ í¬ì¸íŠ¸ í™˜ë¶ˆ + ìƒí’ˆ ì¬ê³  ë³µêµ¬
- í™˜ë¶ˆ í¬ì¸íŠ¸ëŠ” ìƒˆ í¬ì¸íŠ¸ë¡œ ìƒì„± (30ì¼ ìœ íš¨ê¸°ê°„ ë¶€ì—¬)

## ğŸ§ª í…ŒìŠ¤íŠ¸ (Testing)

### í…ŒìŠ¤íŠ¸ ê³„ì •

ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸ ì‹œ ì•„ë˜ ë‹‰ë„¤ì„ì„ ì‚¬ìš©í•˜ì„¸ìš”:

```
ë‹‰ë„¤ì„: testuser
```

> ë¡œê·¸ì¸ ì‹œ ë‹‰ë„¤ì„ë§Œ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ê³„ì •ì´ ìƒì„±ë©ë‹ˆë‹¤.

### í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```bash
# ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
./gradlew test

# íŠ¹ì • í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
./gradlew test --tests "RouletteServiceTest"
```

## ğŸ“‚ í”„ë¡œì íŠ¸ êµ¬ì¡° (Project Structure)

```
src/main/kotlin/lg/voltup/
â”œâ”€â”€ config/          # CORS, Swagger ì„¤ì •
â”œâ”€â”€ controller/      # REST API ì—”ë“œí¬ì¸íŠ¸
â”‚   â””â”€â”€ dto/         # ìš”ì²­/ì‘ë‹µ DTO
â”œâ”€â”€ entity/          # JPA ì—”í‹°í‹°
â”‚   â””â”€â”€ enums/       # ìƒíƒœ ì—´ê±°í˜• (OrderStatus, PointStatus, ParticipationStatus)
â”œâ”€â”€ exception/       # ì»¤ìŠ¤í…€ ì˜ˆì™¸ ë° GlobalExceptionHandler
â”œâ”€â”€ repository/      # ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ
â”œâ”€â”€ service/         # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â””â”€â”€ BackendApplication.kt
```

